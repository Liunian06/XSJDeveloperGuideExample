# TODO - "教程机"小手机 PWA 项目

## 项目背景
用户正在编写一个 AI-Native 产品的开发教程。该 AI 产品在行业内一般被称为"小手机"，核心产品逻辑是在浏览器中通过 HTML、JavaScript 和 CSS 开发 PWA 应用，实现一个虚拟操作系统的完整体验。系统内包含微信、QQ、抖音等常见软件形态，但所有应用均不连接真实平台环境，而是基于用户自定义人设构建高拟真的 AI Roleplay 闭环，以提升长期陪伴体验与沉浸感。

## 一、项目初始化与架构
- [x] 创建 SPA 基础目录结构（`index.html`、`styles/`、`scripts/`、`assets/`、`manifest.json`、`sw.js`）
- [x] 搭建 PWA 基础能力（`manifest.json`、Service Worker 注册、离线缓存策略）
- [x] 配置移动端视口与 iOS 风格基础变量（圆角、阴影、间距、字体层级）

## 二、页面与 UI（iOS 风格 + 微信绿色主题）
- [x] 基于 `color.txt` 建立统一主题变量（浅色/深色两套 token），并拆分到 `styles/theme.css`
- [x] 启用系统主题自动跟随：使用 `@media (prefers-color-scheme: dark)` 自动切换深浅色
- [x] 在 `html` 上声明 `color-scheme: light dark`，确保表单/滚动条等原生控件风格同步
- [x] 实现启动界面（品牌 Logo、应用名、启动动画与加载状态）
- [x] 实现 iOS 风格锁屏页面（时间日期、解锁输入区、壁纸背景、模糊效果）
- [x] 实现仿 iOS 主屏幕页面（天气/时间小组件、应用网格、底部 Dock）
- [x] 实现聊天超级 App 页面（整合聊天、群聊、自动总结、朋友圈）
- [x] 实现联系人 App 页面
- [x] 实现记忆 App 页面（完整功能：列表、搜索、标签筛选、重要度、新增/编辑/删除、详情查看）
- [x] 实现日记 App 页面（完整功能：列表、搜索、情绪筛选、月份分组、新增/编辑/删除、详情查看）
- [x] 实现论坛 App 页面（完整功能：列表、搜索、标签筛选、点赞、新增/编辑/删除、详情查看）
- [ ] 实现世界书 App 页面
- [ ] 实现预设 App 页面
- [x] 实现设置 App 页面（数据库导入导出、API 预设入口）
- [ ] 实现表情包 App 页面
- [x] 统一视觉规范：以 `#07C160` 为品牌主色，搭配 `#10AEFF`（信息高亮）、`#FA9D3B`（提醒）、`#FA5151`（错误/危险），并保持圆角卡片、气泡阴影与留白
- [x] 完成移动端适配（常见手机宽度 320-430px，分辨率 2K-2.5K）
  - [x] 设置视口元标签：`<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">`
  - [x] 使用 CSS 重置与标准化：移除默认边距、设置 `box-sizing: border-box`、禁用长按高亮
  - [x] 采用响应式单位：主布局使用 `rem` + `vw/vh`，字体使用 `clamp()` 实现自适应缩放
  - [x] 适配安全区域：使用 `env(safe-area-inset-*)` 处理刘海屏/灵动岛
  - [x] 处理状态栏高度：iOS 约 47px，Android 约 24-40px，动态计算顶部留白
  - [x] 处理底部手势区：预留 34px 底部安全区域，避免内容被手势条遮挡
  - [x] 适配 2K 分辨率（1440×3200，~520ppi）：使用高分辨率图片（@2x/@3x），SVG 优先
  - [x] 适配 2.5K 分辨率（1440×3600+，~600ppi）：确保图标/文字在超高 DPI 下清晰
  - [x] 设置 CSS 像素密度：`image-rendering: -webkit-optimize-contrast` 提升锐度
  - [x] 媒体查询断点：按宽度分档（320/360/375/390/414/430px）微调布局
  - [x] 横屏适配：检测 `orientation`，调整布局或提示用户竖屏使用
  - [x] 触摸优化：按钮最小点击区域 44×44px，禁用双击缩放，优化滚动惯性
  - [x] 性能优化：图片懒加载、CSS 含 will-change、减少重绘重排
  - [x] 测试覆盖：在 iOS（Safari）、Android（Chrome）主流机型验证显示与交互

## 三、核心功能开发（按系统能力与应用拆分）

### 3.1 启动、解锁与应用生命周期
- [ ] 实现应用启动流程：进入应用先展示锁屏，再进入主屏
- [ ] 设计冷启动/热启动状态机：`cold_start`、`locked`、`unlocked`、`background`、`restored`
- [ ] 首次进入判定逻辑：数据库无密码时进入引导设置，否则进入输入密码流程
- [ ] 实现 6 位数字密码设置流程：输入两次一致校验、弱密码提示（如 `123456`/`000000`）
- [ ] 实现密码输入与解锁流程：逐位输入、退格删除、提交校验、失败反馈
- [ ] 增加连续失败保护：失败次数统计、短暂锁定、倒计时后可重试
- [ ] 支持锁屏快捷操作：长时间无操作自动锁屏（返回主屏不自动上锁）
- [ ] 支持会话恢复：解锁后恢复上次打开应用与滚动位置（可配置）
- [ ] 明确生命周期事件：页面可见性切换、刷新恢复、离线恢复、异常崩溃恢复

### 3.2 全局路由、导航与上下文传递
- [ ] 实现主屏应用启动逻辑（点击不同应用进入对应页面）
- [ ] 设计统一路由规范：页面标识、参数命名、返回栈规则、深链接约定
- [ ] 实现页面间跳转与上下文传递（URL 参数或路由状态）
- [ ] 实现统一导航容器：顶部标题、返回按钮、二级页面层级展示
- [ ] 增加跨应用跳转能力：联系人详情一键跳转聊天、记忆条目跳转关联会话等
- [ ] 增加路由兜底：参数缺失/非法时回退至安全页面并提示

### 3.3 数据模型与领域对象
- [ ] 构建统一数据模型：联系人、会话、群聊、朋友圈动态、记忆、日记、论坛帖子、世界书条目、预设、表情包
- [ ] 为每类对象定义字段规范：`id`、`created_at`、`updated_at`、`is_deleted`、`version`
- [ ] 统一时间与排序策略：统一使用 UTC+8 存储与展示、列表默认排序规则
- [ ] 设计软删除机制：回收站可选、恢复窗口、永久删除策略
- [ ] 增加数据关联约束：删除联系人时关联会话与记忆引用的处理策略
- [ ] 设计字段迁移兼容：旧字段映射、新字段默认值、升级失败回滚

### 3.4 消息收发与自动回复引擎
- [ ] 实现发送文字消息功能（输入校验、回车发送/按钮发送）
- [ ] 定义消息实体：文本、系统消息、回复链、草稿状态、发送状态
- [ ] 实现消息发送状态流转：`draft`、`sending`、`sent`、`failed`、`retrying`
- [ ] 增加消息输入体验：最大长度、换行策略、@提及（群聊可选）
- [ ] 实现后台自动回复逻辑（在设置中可开关、规则可配置，应用于聊天与群聊）
- [ ] 自动回复规则维度：按联系人、按群聊、按关键词、按时间窗、全局兜底
- [ ] 自动回复安全策略：频控、防循环回复、黑名单关键词、静默时段
- [ ] 增加规则调试模式：命中日志、模拟输入、预览输出

### 3.5 聊天超级 App（独立需求拆解）
- [ ] 会话列表：最近消息预览、未读计数、置顶/免打扰、草稿标记、下拉刷新
- [ ] 私聊详情：消息气泡、时间分隔、长按菜单（复制/删除/引用/转发占位）
- [ ] 群聊列表：群名称、成员数、最近发言、未读聚合
- [ ] 群聊详情：群公告、成员列表入口、@消息高亮、系统通知消息
- [ ] 朋友圈时间流：图文动态卡片、点赞评论、按时间分页加载
- [ ] 自动总结卡片：按会话生成摘要、支持固定在会话顶部、可手动刷新
- [ ] 搜索能力：按联系人/群名/消息关键词搜索并高亮命中片段
- [ ] 数据性能：会话 1k+、消息 50k 级别下保证列表滚动与检索可用
- [ ] API 上下文构建器：统一实现 `buildChatContext()`，按固定优先级拼装请求上下文
- [ ] System Prompt 顺序固定：`roleplay_core` -> `preset` -> `worldbook` -> `assistant_persona` -> `user_persona` -> `runtime_time`
- [ ] Role Play 主提示词规范：定义角色目标、语气风格、边界约束、禁止出戏规则、冲突指令优先级
- [ ] 预设与世界书注入策略：仅注入当前会话命中条目，支持长度上限与去重，避免上下文污染
- [ ] 新建聊天强约束：必须从联系人中选择“角色人设 + 用户人设”（`assistant_contact_id`、`user_contact_id`）
- [ ] 人设注入规范：联系人中的角色设定与用户设定在 System 中分段注入，并保留来源标记
- [ ] 实时系统时间注入：每次发送前读取真实系统时间（含时区），写入 `runtime_time`，禁止复用旧时间
- [ ] User Prompt 规范：包含格式化聊天记录（带说话人标签）与用户本轮输入，不将角色规则放入 User 段
- [ ] 聊天记录格式：至少支持 `[用户]`、`[角色]`、`[系统]` 标签，群聊支持 `[成员名]` 标签
- [ ] Token 预算与裁剪策略：优先保留 roleplay 与双人设，超限时先裁剪旧聊天记录，再裁世界书扩展信息
- [ ] 上下文注入规则：预设/世界书/人设按固定顺序拼装，不做额外清洗拦截逻辑
- [ ] 请求快照留存：保存上下文摘要、模型参数、响应耗时与错误码，用于调试与复现
- [ ] Provider 适配层：同一上下文可转换到 OpenAI/Gemini/Anthropic 三类请求格式并保持语义一致

### 3.6 联系人 App（独立需求拆解）
- [ ] 联系人列表：支持新增/编辑/删除联系人，展示头像、昵称、人设三要素
- [ ] 联系人搜索与筛选：按昵称关键字、人设标签、拼音首字母/模糊匹配
- [ ] 联系人详情页：完整资料、最近互动记录、快捷发起私聊/群聊
- [ ] 联系人排序与分组：按最近联系时间、昵称字母排序，支持自定义分组
- [ ] 联系人快捷操作：置顶关注、收藏常用、批量选择（可选）
- [ ] 联系人数据校验：昵称必填与长度限制、人设长度限制、标签数量限制
- [ ] 联系人导入导出：JSON 导入导出（含头像元信息），字段兼容校验

### 3.7 联系人头像与媒体存储（独立需求拆解）
- [ ] 头像存储方案：统一使用 IndexedDB `BLOB`，数据库字段保存 `avatar_blob` 与元信息；不默认 Base64
- [ ] 联系人模型扩展头像字段：`avatar_blob`、`avatar_mime`、`avatar_updated_at`
- [ ] 头像上传流程：本地选择后压缩（最长边 512-1024，JPEG 质量 0.75-0.85）再持久化
- [ ] 头像更新清理策略：替换头像时覆盖旧 BLOB，避免垃圾数据堆积
- [ ] 头像读取封装：统一转换为可渲染 URL，保证列表与详情稳定展示
- [ ] 文件校验策略：类型白名单、大小上限、异常文件拦截与错误提示

### 3.8 记忆 App（独立需求拆解）
- [x] 记忆条目新增/编辑/删除：标题、正文、标签、重要度、时间戳
- [x] 分类体系：按主题标签、人物标签、场景标签多维过滤
- [x] 重要度机制：星级或优先级，支持仅看高优先记忆
- [ ] 关联能力：记忆与联系人、会话、日记、世界书条目互链
- [ ] 复习机制（可选）：按遗忘曲线生成复习列表与提醒
- [x] 搜索能力：全文检索 + 标签筛选 + 时间范围筛选

### 3.9 日记 App（独立需求拆解）
- [x] 按日历写作：日视图快速新建、补写历史日期、当天草稿自动恢复
- [x] 日记列表：按月分组、摘要预览、字数统计、最近编辑时间
- [x] 情绪标签：多选标签、情绪趋势统计（周/月）
- [x] 全文检索：关键词检索、日期范围过滤、标签过滤
- [x] 写作体验：自动保存、撤销恢复、超长文本分段渲染
- [ ] 隐私保护：可选本地二级加锁（进入日记页再次验证）

### 3.10 论坛 App（独立需求拆解）
- [x] 帖子列表：按最新/最热排序，支持标签筛选与分页加载
- [x] 发帖与编辑：标题、正文、标签、草稿暂存、发布校验
- [ ] 评论回复：楼中楼结构、@回复、时间排序
- [x] 点赞收藏：防重复点赞、取消点赞、收藏列表管理
- [x] 内容治理：敏感词拦截、超长内容限制、空内容防提交
- [ ] 个人视图：我的帖子、我的评论、我的收藏

### 3.11 世界书 App（独立需求拆解）
- [ ] 条目管理：角色/地点/设定三类模板，支持新增编辑删除
- [ ] 字段规范：基础信息、背景描述、能力设定、阵营关系等结构化字段
- [ ] 关系链接：角色-地点、角色-角色、事件-设定双向关联
- [ ] 版本记录：每次编辑生成版本快照，可查看差异与回滚
- [ ] 关系可视化（可选）：关系图谱视图，支持点击节点跳转详情
- [ ] 一致性检查：冲突设定提示（时间线冲突、身份冲突）

### 3.12 预设 App（独立需求拆解）
- [ ] 预设模板管理：新增/编辑/删除/复制、分组与排序
- [ ] 变量占位符：如 `{{角色}}`、`{{语气}}`、`{{场景}}`，支持预览替换结果
- [ ] 快速套用：在聊天输入栏一键插入预设内容
- [ ] 文风预设绑定：预设仅负责输出风格与写作约束，不承载 API 参数
- [ ] 预设渲染规则：支持与人设、世界书协同注入，确保语气/风格可控
- [ ] 文风预设校验：长度、变量完整性、禁空校验，非法值阻止保存
- [ ] 模板版本：保留历史版本并支持回退
- [ ] 导入导出：预设 JSON 导入导出与字段兼容

### 3.13 设置 App（独立需求拆解）
- [ ] 数据库导出 JSON：支持全量导出、按模块导出、导出元信息记录
- [ ] 数据库导入恢复：格式校验、冲突策略（覆盖/合并）、失败回滚
- [ ] API 预设管理：支持 OpenAI/Gemini/Anthropic 三类接口
- [ ] 支持三类接口的自定义 Base URL 与模型列表缓存
- [ ] 拉取模型按钮与快捷选择：失败提示、重试机制、最后更新时间
- [ ] 支持保存多个 API 预设并快速切换（含默认预设设置），切换时同步生效 `temperature`、`top_p`、`stream`
- [ ] 测试连接功能：固定 Prompt 发送并展示响应、耗时、模型 id、厂商信息
- [ ] 全局设置项：自动回复开关、主题模式、数据清理入口、关于信息

### 3.14 表情包 App（独立需求拆解）
- [ ] 分类浏览：按主题分组，支持最近使用与常用分类
- [ ] 关键词搜索：按名称、别名、标签检索
- [ ] 收藏常用：收藏/取消收藏、排序管理、同步到聊天快捷栏
- [ ] 聊天输入栏快捷发送：点击即插入或直接发送（可配置）
- [ ] 资源管理：静态图/GIF 区分、文件大小限制、加载失败兜底
- [ ] 扩展能力：支持本地导入表情包并自动生成缩略图（可选）

## 四、本地数据库（IndexedDB）
- [ ] 封装 IndexedDB 存储模块（建库、事务、CRUD、容错）
- [ ] 设计对象仓库与索引（`settings`、`contacts`、`conversations`、`messages`、`groups`、`moments`、`memories`、`journals`、`forums`、`worldbook`、`presets`、`stickers`）
- [ ] 在 `settings` 中存储解锁密码（作为本地功能特性使用，不做哈希）
- [ ] 在 `settings` 中实现数据库导入导出（JSON 备份/恢复）
- [ ] 保存并持久化各 App 数据（刷新后可恢复）
- [ ] 首次启动初始化默认联系人与示例内容（聊天、群聊、朋友圈、论坛、世界书等）
- [ ] 增加配额阈值策略：当数据达到配额的 70%/80%/90% 时，自动申请更稳定的存储能力（`navigator.storage.persist()`）；若申请成功则继续扩容使用，若申请失败则提示用户当前用量已接近上限并引导清理旧数据
- [ ] 增加存储持久化申请（`navigator.storage.persist()`）与失败兜底策略
- [ ] 增加 IndexedDB 索引优化：为高频查询字段建立复合索引并定期评估读写性能
- [ ] 增加迁移脚本（可选）：将旧 `localStorage` 聊天数据迁移到 `IndexedDB`

## 五、体验优化与质量保障
- [ ] 增加基础交互反馈（解锁失败震动/提示、发送动画、按钮可用态、空状态）
- [ ] 覆盖深浅色模式回归测试（锁屏、主屏、聊天超级 App、各子应用页面在两种主题下可读性与对比度达标）
- [ ] 处理异常与边界场景（空输入、超长文本、无会话数据、密码设置中断、配额超限写入失败、导入数据格式错误）
- [ ] 自测关键流程（首次设置密码、解锁进入主屏、应用跳转、离线访问、收发消息、API 预设保存与切换、模型拉取与选择、数据库导入导出、刷新恢复、低空间场景、系统主题自动切换）
- [ ] 整理 README 使用说明（启动方式、功能说明、后续可扩展项）
